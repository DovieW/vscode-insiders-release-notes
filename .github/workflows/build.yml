name: Generate changelog for an Insiders build

on:
  workflow_dispatch:
    inputs:
      buildSha:
        description: "VS Code Insiders build commit SHA (full SHA or unique prefix; from the update service commits feed)"
        required: true
        type: string
      force:
        description: "Force rebuild even if this build SHA is already processed"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "insiders-build"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: master

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Generate build changelog page (AI required)
        env:
          GITHUB_TOKEN: ${{ github.token }}
          TARGET_REPO: microsoft/vscode
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4.1-mini
        run: npm run update-data -- --build-sha "${{ inputs.buildSha }}" ${{ inputs.force && '--force' || '' }}

      - name: Commit generated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data docs
          if git diff --cached --quiet; then
            echo "No changes to commit. Continuing (useful for redeploys / config-only changes)."
          else
            tag=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.out/build.json','utf8')).tag)")
            git commit -m "chore(insiders): ${tag}"
            git push
          fi

      - name: Create GitHub Release (AI notes only)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ ! -f .out/build.json ]; then
            echo "No .out/build.json found (likely a redeploy / build already processed). Skipping release creation."
            exit 0
          fi

          tag=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.out/build.json','utf8')).tag)")
          title=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.out/build.json','utf8')).title)")
          notes=.out/release-notes.md
          meta=.out/build.json
          target=$(git rev-parse HEAD)

          # Build the GitHub Pages URL for this build page.
          # Pages base is /<repo>/ for project pages.
          repo_name=${{ github.event.repository.name }}
          pages_base="https://${{ github.repository_owner }}.github.io/${repo_name}"
          slug=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.out/build.json','utf8')).slug)")
          build_url="${pages_base}/builds/${slug}"

          # Extract some useful metadata for the release header.
          build_sha=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.out/build.json','utf8')).buildSha)")
          prev_sha=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.out/build.json','utf8')).previousSha)")
          version=$(node -e "console.log(JSON.parse(require('fs').readFileSync('.out/build.json','utf8')).version)")
          short_build=${build_sha:0:7}
          short_prev=${prev_sha:0:7}
          upstream="https://github.com/microsoft/vscode"
          commit_url="${upstream}/commit/${build_sha}"
          prev_url="${upstream}/commit/${prev_sha}"
          compare_url="${upstream}/compare/${prev_sha}...${build_sha}"

          # Compose a release body that includes the build metadata + link, then the AI notes.
          release_body=.out/release-body.md
          {
            echo "Build page: ${build_url}";
            echo;
            echo "Commit: ${commit_url} · Previous: ${prev_url} · Compare: ${compare_url}";
            echo "Version: ${version}";
            echo;
            cat "$notes";
          } > "$release_body"

          # Ensure the release exists before attempting to upload assets.
          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Release $tag already exists; skipping creation."
          else
            gh release create "$tag" \
              --title "$title" \
              --notes-file "$release_body" \
              --target "$target"
          fi

          # Attach official installer link artifacts (NOT the binaries themselves).
          if [ -f .out/installers.json ]; then
            gh release upload "$tag" .out/installers.json --clobber
          fi
          if [ -f .out/installers.md ]; then
            gh release upload "$tag" .out/installers.md --clobber
          fi

      - name: Build site
        run: npm run docs:build

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
